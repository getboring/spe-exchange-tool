import{c as E,b as L,d as V,r as m,u as W,e as D,t as C,s as F,j as e,X as O,C as T}from"./index-CPFkeXTL.js";import{C as B,W as q,D as $}from"./constants-Cyhwx-4M.js";import{C as M}from"./check-Ca9kXC9N.js";import{P as H}from"./pencil-xFFRPZLi.js";import{T as Y,a as z}from"./triangle-alert-Bfna1AUJ.js";import{C as G}from"./circle-check-big-CZ38CVVF.js";import{u as J}from"./settings-store-V5ljlfDl.js";const K=[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]],X=E("chevron-down",K);const Q=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],Z=E("chevron-up",Q);const ee=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],R=E("circle-alert",ee);const se=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],te=E("upload",se),A={imageData:null,imagePreview:null,mediaType:null,scannedItems:[],isScanning:!1,error:null},k=L()(V(r=>({...A,setImage:(s,l,c)=>r({imageData:s,imagePreview:l,mediaType:c,error:null}),clearImage:()=>r({imageData:null,imagePreview:null,mediaType:null}),setScannedItems:s=>r({scannedItems:s,error:null}),updateItem:(s,l)=>r(c=>({scannedItems:c.scannedItems.map(a=>a.id===s?{...a,...l}:a)})),removeItem:s=>r(l=>({scannedItems:l.scannedItems.filter(c=>c.id!==s)})),setScanning:s=>r({isScanning:s}),setError:s=>r({error:s,isScanning:!1}),reset:()=>r(A)}),{name:"ScanStore"}));function ae(){const[r,s]=m.useState(!1),[l,c]=m.useState(null),a=W(),{user:i}=D(),{scannedItems:o,reset:g}=k(),p=m.useCallback(async(h,x,f)=>{if(!i){c("You must be logged in to save items");return}if(o.length===0){c("No items to save");return}s(!0),c(null);try{const n=o.reduce((v,S)=>{const u=U(S);return v+u},0),j=n-h,t={user_id:i.id,source:x||null,notes:f||null,total_cost:C(h),estimated_value:C(n),estimated_profit:C(j),status:"active",actual_revenue:null,actual_profit:null,actual_roi:null},{data:d,error:N}=await F.from("deals").insert(t).select().single();if(N)throw new Error(`Failed to create deal: ${N.message}`);const y=d,w=o.map(v=>{const S=U(v),u=n>0?S/n:1/o.length,b=h*u;return{user_id:i.id,name:v.name,platform:v.platform,condition:v.condition_guess,type:v.type,weight:v.weight,status:"in_stock",loose_price:C(v.loose_price),cib_price:C(v.cib_price),new_price:C(v.new_price),purchase_cost:C(b),estimated_value:C(S),deal_id:y.id,sale_price:null,sale_platform:null,sale_date:null,sale_fees:null,shipping_cost:null,actual_profit:null,thumbnail_url:null}}),{error:_}=await F.from("items").insert(w);if(_)throw new Error(`Failed to save items: ${_.message}`);const I={user_id:i.id,items_found:o.length};await F.from("scans").insert(I),g(),a("/inventory")}catch(n){c(n instanceof Error?n.message:"Failed to save items")}finally{s(!1)}},[i,o,g,a]);return{saving:r,error:l,saveScan:p}}function U(r){switch(r.condition_guess){case"sealed":return r.new_price;case"cib":return r.cib_price;default:return r.loose_price}}async function ne(r,s=1600,l=.85){return new Promise((c,a)=>{const i=new FileReader;i.onload=o=>{const g=new Image;g.onload=()=>{let p=g.width,h=g.height;p>s&&(h=h*s/p,p=s);const x=document.createElement("canvas");x.width=p,x.height=h;const f=x.getContext("2d");if(!f){a(new Error("Could not get canvas context"));return}f.drawImage(g,0,0,p,h);const n=r.type==="image/png"?"image/png":"image/jpeg",j=x.toDataURL(n,l).split(",")[1];c({base64:j,mediaType:n})},g.onerror=()=>a(new Error("Failed to load image")),g.src=o.target?.result},i.onerror=()=>a(new Error("Failed to read file")),i.readAsDataURL(r)})}function re(r){return URL.createObjectURL(r)}function ce(r){URL.revokeObjectURL(r)}function le({onScan:r,disabled:s}){const l=m.useRef(null),{imagePreview:c,isScanning:a,setImage:i,clearImage:o}=k(),g=m.useCallback(async n=>{try{const j=re(n),{base64:t,mediaType:d}=await ne(n);i(t,j,d)}catch{}},[i]),p=m.useCallback(n=>{const j=n.target.files?.[0];j&&g(j)},[g]),h=m.useCallback(()=>{l.current&&(l.current.capture="environment",l.current.click())},[]),x=m.useCallback(()=>{l.current&&(l.current.removeAttribute("capture"),l.current.click())},[]),f=m.useCallback(()=>{c&&ce(c),o(),l.current&&(l.current.value="")},[c,o]);return e.jsxs("div",{className:"space-y-4",children:[e.jsx("input",{ref:l,type:"file",accept:"image/*",onChange:p,className:"hidden"}),e.jsx("div",{className:"relative aspect-video overflow-hidden rounded-lg border-2 border-dashed bg-muted/50",children:c?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:c,alt:"Preview",className:"h-full w-full object-contain"}),e.jsx("button",{onClick:f,disabled:a,"aria-label":"Clear image",className:"absolute right-2 top-2 rounded-full bg-background/80 p-1.5 hover:bg-background disabled:opacity-50",children:e.jsx(O,{className:"h-4 w-4"})})]}):e.jsxs("div",{className:"flex h-full flex-col items-center justify-center text-muted-foreground",children:[e.jsx(T,{className:"h-12 w-12"}),e.jsx("p",{className:"mt-2 text-sm",children:"Take a photo or upload an image"})]})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:h,disabled:s||a,className:"flex flex-1 items-center justify-center gap-2 rounded-lg border bg-background px-4 py-3 font-medium hover:bg-accent disabled:opacity-50",children:[e.jsx(T,{className:"h-5 w-5"}),"Camera"]}),e.jsxs("button",{onClick:x,disabled:s||a,className:"flex flex-1 items-center justify-center gap-2 rounded-lg border bg-background px-4 py-3 font-medium hover:bg-accent disabled:opacity-50",children:[e.jsx(te,{className:"h-5 w-5"}),"Upload"]})]}),c&&e.jsx("button",{onClick:r,disabled:s||a,className:"flex w-full items-center justify-center gap-2 rounded-lg bg-primary px-4 py-3 font-medium text-primary-foreground hover:bg-primary/90 disabled:opacity-50",children:a?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"h-5 w-5 animate-spin rounded-full border-2 border-current border-t-transparent"}),"Scanning..."]}):"Scan Image"})]})}const ie=m.memo(function({item:s}){const[l,c]=m.useState(!1),[a,i]=m.useState({name:s.name,condition_guess:s.condition_guess,weight:s.weight,loose_price:s.loose_price,cib_price:s.cib_price,new_price:s.new_price}),{updateItem:o,removeItem:g}=k(),p=()=>{o(s.id,a),c(!1)},h=()=>{i({name:s.name,condition_guess:s.condition_guess,weight:s.weight,loose_price:s.loose_price,cib_price:s.cib_price,new_price:s.new_price}),c(!1)},x=()=>{switch(s.confidence){case"high":return{icon:G,className:"text-green-500"};case"medium":return{icon:z,className:"text-yellow-500"};case"low":return{icon:R,className:"text-red-500"};default:return{icon:R,className:"text-muted-foreground"}}},{icon:f,className:n}=x(),j=()=>{switch(s.condition_guess){case"sealed":return s.new_price;case"cib":return s.cib_price;default:return s.loose_price}};return l?e.jsxs("div",{className:"rounded-lg border p-4 space-y-3",children:[e.jsx("input",{type:"text",value:a.name,onChange:t=>i({...a,name:t.target.value}),className:"w-full rounded border bg-background px-2 py-1 text-sm",placeholder:"Item name"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("select",{value:a.condition_guess,onChange:t=>i({...a,condition_guess:t.target.value}),className:"rounded border bg-background px-2 py-1 text-sm",children:B.map(t=>e.jsx("option",{value:t,children:t.toUpperCase()},t))}),e.jsx("select",{value:a.weight,onChange:t=>i({...a,weight:t.target.value}),className:"rounded border bg-background px-2 py-1 text-sm",children:q.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Loose"}),e.jsx("input",{type:"number",value:a.loose_price,onChange:t=>i({...a,loose_price:Number(t.target.value)}),className:"w-full rounded border bg-background px-2 py-1 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"CIB"}),e.jsx("input",{type:"number",value:a.cib_price,onChange:t=>i({...a,cib_price:Number(t.target.value)}),className:"w-full rounded border bg-background px-2 py-1 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Sealed"}),e.jsx("input",{type:"number",value:a.new_price,onChange:t=>i({...a,new_price:Number(t.target.value)}),className:"w-full rounded border bg-background px-2 py-1 text-sm"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:p,className:"flex flex-1 items-center justify-center gap-1 rounded bg-primary px-3 py-1.5 text-sm text-primary-foreground",children:[e.jsx(M,{className:"h-4 w-4"}),"Save"]}),e.jsxs("button",{onClick:h,className:"flex flex-1 items-center justify-center gap-1 rounded border px-3 py-1.5 text-sm",children:[e.jsx(O,{className:"h-4 w-4"}),"Cancel"]})]})]}):e.jsxs("div",{className:"rounded-lg border p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{className:`h-4 w-4 flex-shrink-0 ${n}`}),e.jsx("h3",{className:"font-medium truncate",children:s.name})]}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("span",{className:"rounded bg-secondary px-1.5 py-0.5 text-xs",children:s.platform}),e.jsx("span",{className:"rounded bg-secondary px-1.5 py-0.5 text-xs uppercase",children:s.condition_guess}),e.jsx("span",{children:s.weight})]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>c(!0),"aria-label":"Edit item",className:"rounded p-1.5 hover:bg-accent",children:e.jsx(H,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>g(s.id),"aria-label":"Remove item",className:"rounded p-1.5 hover:bg-accent text-destructive",children:e.jsx(Y,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("span",{className:"text-muted-foreground",children:["L: ",e.jsxs("span",{className:"text-foreground",children:["$",s.loose_price]})]}),e.jsxs("span",{className:"text-muted-foreground",children:["CIB: ",e.jsxs("span",{className:"text-foreground",children:["$",s.cib_price]})]}),e.jsxs("span",{className:"text-muted-foreground",children:["New: ",e.jsxs("span",{className:"text-foreground",children:["$",s.new_price]})]})]}),e.jsxs("span",{className:"font-medium text-green-600",children:["$",j()]})]}),s.notes&&e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:s.notes})]})});function oe(){const{scannedItems:r,error:s}=k();if(s)return e.jsx("div",{className:"rounded-lg border border-destructive/50 bg-destructive/10 p-4 text-center",children:e.jsx("p",{className:"text-sm text-destructive",children:s})});if(r.length===0)return e.jsxs("div",{className:"rounded-lg border p-4 text-center text-muted-foreground",children:[e.jsx("p",{children:"No items scanned yet."}),e.jsx("p",{className:"mt-1 text-sm",children:"Take a photo or upload an image to get started."})]});const l=r.reduce((c,a)=>{const i=a.condition_guess==="sealed"?a.new_price:a.condition_guess==="cib"?a.cib_price:a.loose_price;return c+i},0);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-semibold",children:["Scanned Items (",r.length,")"]}),e.jsxs("span",{className:"text-sm font-medium text-green-600",children:["Total: $",l.toFixed(2)]})]}),e.jsx("div",{className:"space-y-3",children:r.map(c=>e.jsx(ie,{item:c},c.id))})]})}function de({onSave:r,saving:s}){const[l,c]=m.useState(!0),[a,i]=m.useState(""),[o,g]=m.useState($[0]),[p,h]=m.useState(""),{scannedItems:x}=k(),{targetRoi:f}=J(),n=m.useMemo(()=>{const t=x.reduce((u,b)=>{const P=b.condition_guess==="sealed"?b.new_price:b.condition_guess==="cib"?b.cib_price:b.loose_price;return u+P},0),d=parseFloat(a)||0,N=t-d,y=d>0?N/d*100:0,w=t*100/(f+100);let _={text:"PASS",className:"text-red-500"};y>=100?_={text:"STRONG BUY",className:"text-green-600 font-bold"}:y>=50?_={text:"BUY",className:"text-green-500"}:y>=f?_={text:"OK",className:"text-yellow-500"}:y>=0?_={text:"PASS",className:"text-orange-500"}:_={text:"HARD PASS",className:"text-red-600 font-bold"};const I=[...x].sort((u,b)=>{const P=u.condition_guess==="sealed"?u.new_price:u.condition_guess==="cib"?u.cib_price:u.loose_price;return(b.condition_guess==="sealed"?b.new_price:b.condition_guess==="cib"?b.cib_price:b.loose_price)-P}),v=I.filter(u=>(u.condition_guess==="sealed"?u.new_price:u.condition_guess==="cib"?u.cib_price:u.loose_price)>=20),S=I.filter(u=>(u.condition_guess==="sealed"?u.new_price:u.condition_guess==="cib"?u.cib_price:u.loose_price)<20);return{totalValue:t,profit:N,roi:y,maxOffer:w,recommendation:_,carriers:v,deadWeight:S}},[x,a,f]),j=()=>{const t=parseFloat(a)||0;r(t,o,p)};return x.length===0?null:e.jsxs("div",{className:"rounded-lg border",children:[e.jsxs("button",{onClick:()=>c(!l),className:"flex w-full items-center justify-between p-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Lot Calculator"}),l?e.jsx(Z,{className:"h-5 w-5"}):e.jsx(X,{className:"h-5 w-5"})]}),l&&e.jsxs("div",{className:"border-t p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"asking-price",className:"text-sm text-muted-foreground",children:"Asking Price"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground",children:"$"}),e.jsx("input",{id:"asking-price",type:"number",value:a,onChange:t=>i(t.target.value),placeholder:"0.00",className:"w-full rounded-lg border bg-background py-2 pl-7 pr-3"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"rounded bg-muted p-3",children:[e.jsx("div",{className:"text-muted-foreground",children:"Total Value"}),e.jsxs("div",{className:"text-lg font-bold",children:["$",n.totalValue.toFixed(2)]})]}),e.jsxs("div",{className:"rounded bg-muted p-3",children:[e.jsx("div",{className:"text-muted-foreground",children:"Profit"}),e.jsxs("div",{className:`text-lg font-bold ${n.profit>=0?"text-green-600":"text-red-600"}`,children:["$",n.profit.toFixed(2)]})]}),e.jsxs("div",{className:"rounded bg-muted p-3",children:[e.jsx("div",{className:"text-muted-foreground",children:"ROI"}),e.jsxs("div",{className:`text-lg font-bold ${n.roi>=f?"text-green-600":"text-orange-500"}`,children:[n.roi.toFixed(0),"%"]})]}),e.jsxs("div",{className:"rounded bg-muted p-3",children:[e.jsx("div",{className:"text-muted-foreground",children:"Recommendation"}),e.jsx("div",{className:`text-lg ${n.recommendation.className}`,children:n.recommendation.text})]})]}),e.jsxs("div",{className:"rounded bg-secondary/50 p-3 text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Max counter-offer for ",f,"% ROI:"," "]}),e.jsxs("span",{className:"font-medium",children:["$",n.maxOffer.toFixed(2)]})]}),(n.carriers.length>0||n.deadWeight.length>0)&&e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-green-600",children:["Carriers (",n.carriers.length,")"]}),e.jsxs("ul",{className:"mt-1 space-y-1 text-muted-foreground",children:[n.carriers.slice(0,3).map(t=>e.jsx("li",{className:"truncate",children:t.name},t.id)),n.carriers.length>3&&e.jsxs("li",{children:["+",n.carriers.length-3," more"]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-muted-foreground",children:["Dead Weight (",n.deadWeight.length,")"]}),e.jsxs("ul",{className:"mt-1 space-y-1 text-muted-foreground",children:[n.deadWeight.slice(0,3).map(t=>e.jsx("li",{className:"truncate",children:t.name},t.id)),n.deadWeight.length>3&&e.jsxs("li",{children:["+",n.deadWeight.length-3," more"]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"deal-source",className:"text-sm text-muted-foreground",children:"Source"}),e.jsx("select",{id:"deal-source",value:o,onChange:t=>g(t.target.value),className:"mt-1 w-full rounded-lg border bg-background px-3 py-2",children:$.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"deal-notes",className:"text-sm text-muted-foreground",children:"Notes"}),e.jsx("input",{id:"deal-notes",type:"text",value:p,onChange:t=>h(t.target.value),placeholder:"Optional",className:"mt-1 w-full rounded-lg border bg-background px-3 py-2"})]})]}),e.jsx("button",{onClick:j,disabled:s||x.length===0,className:"flex w-full items-center justify-center gap-2 rounded-lg bg-green-600 px-4 py-3 font-medium text-white hover:bg-green-700 disabled:opacity-50",children:s?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"h-5 w-5 animate-spin rounded-full border-2 border-current border-t-transparent"}),"Saving..."]}):"Buy Lot â†’ Add to Inventory"})]})]})}function je(){const{imageData:r,mediaType:s,scannedItems:l,isScanning:c,setScannedItems:a,setScanning:i,setError:o,reset:g}=k(),{session:p}=D(),{saving:h,error:x,saveScan:f}=ae(),n=m.useCallback(async()=>{if(!r||!s){o("Please capture or upload an image first");return}if(!p?.access_token){o("Please sign in to scan items");return}i(!0),o(null);try{const d=await fetch("/api/scan",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p.access_token}`},body:JSON.stringify({image:r,mediaType:s})});if(!d.ok){const w=await d.json().catch(()=>({}));throw new Error(w.error||`Scan failed: ${d.status}`)}const N=await d.json();if(!N.items||N.items.length===0){o("No games detected. Try a clearer photo or add items manually.");return}const y=N.items.map((w,_)=>({...w,id:w.id||`scan-${Date.now()}-${_}`}));a(y)}catch(d){d instanceof Error?d.message.includes("timeout")||d.message.includes("Timeout")?o("Scan timed out. Try a smaller image."):d.message.includes("network")||d.message.includes("fetch")?o("No internet connection. Scanning requires internet."):d.message.includes("Too many requests")?o("Too many scans. Please wait a minute before trying again."):d.message.includes("Authentication")||d.message.includes("token")?o("Session expired. Please refresh the page and try again."):o(d.message):o("Failed to scan image. Please try again.")}finally{i(!1)}},[r,s,p,a,i,o]),j=m.useCallback(async(d,N,y)=>{await f(d,N,y)},[f]),t=m.useCallback(()=>{g()},[g]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Scan Items"}),l.length>0&&e.jsx("button",{onClick:t,className:"text-sm text-muted-foreground hover:text-foreground",children:"Clear All"})]}),e.jsx(le,{onScan:n,disabled:c||h}),x&&e.jsx("div",{className:"rounded-lg border border-destructive/50 bg-destructive/10 p-4 text-center",children:e.jsx("p",{className:"text-sm text-destructive",children:x})}),e.jsx(oe,{}),l.length>0&&e.jsx(de,{onSave:j,saving:h})]})}export{je as ScanPage};
